"use strict";exports.id=963,exports.ids=[963],exports.modules={97309:(t,e,a)=>{a.r(e),a.d(e,{GET:()=>p,POST:()=>p,authOptions:()=>l});var r=a(15592),i=a(32810),n=a(45952);let s=n.ZP.object({DATABASE_URL:n.ZP.string().nonempty(),GOOGLE_CLIENT_ID:n.ZP.string().nonempty(),GOOGLE_CLIENT_SECRET:n.ZP.string().nonempty(),NEXTAUTH_URL:n.ZP.string().nonempty(),NEXTAUTH_SECRET:n.ZP.string().nonempty()}),d=s.parse(process.env);var c=a(75435),u=a(93810),o=a(54901);let l={adapter:(0,c.N)(i._),providers:[(0,o.Z)({clientId:d.GOOGLE_CLIENT_ID,clientSecret:d.GOOGLE_CLIENT_SECRET})],callbacks:{session:({session:t,user:e})=>(t.user.id=e.id,t)},events:{async signIn({user:t}){await (0,r.Gt)(t.id)}}},p=(0,u.default)(l)},15592:(t,e,a)=>{a.d(e,{Bk:()=>createCart,Gt:()=>mergeAnonymousCartIntoUserCart,dv:()=>getCart});var r=a(97309),i=a(3471),n=a(78561),s=a(32810);async function getCart(){let t=await (0,i.getServerSession)(r.authOptions),e=null;if(t)e=await s._.cart.findFirst({where:{userId:t.user.id},include:{items:{include:{product:!0}}}});else{let t=n.cookies().get("localCartId")?.value;e=t?await s._.cart.findUnique({where:{id:t},include:{items:{include:{product:!0}}}}):null}return e?{...e,size:e.items.reduce((t,e)=>t+e.quantity,0),subtotal:e.items.reduce((t,e)=>t+e.quantity*e.product.price,0)}:null}async function createCart(){let t;let e=await (0,i.getServerSession)(r.authOptions);return e?t=await s._.cart.create({data:{userId:e.user.id}}):(t=await s._.cart.create({data:{}}),(0,n.cookies)().set("localCartId",t.id)),{...t,items:[],size:0,subtotal:0}}async function mergeAnonymousCartIntoUserCart(t){let e=n.cookies().get("localCartId")?.value,a=e?await s._.cart.findUnique({where:{id:e},include:{items:!0}}):null;if(!a)return;let r=await s._.cart.findFirst({where:{userId:t},include:{items:!0}});await s._.$transaction(async e=>{if(r){let t=function(...t){return t.reduce((t,e)=>(e.forEach(e=>{let a=t.find(t=>t.productId===e.productId);a?a.quantity+=e.quantity:t.push(e)}),t),[])}(a.items,r.items);await e.cartItem.deleteMany({where:{cartId:r.id}}),await e.cartItem.createMany({data:t.map(t=>({cartId:r.id,productId:t.productId,quantity:t.quantity}))})}else await e.cart.create({data:{userId:t,items:{createMany:{data:a.items.map(t=>({productId:t.productId,quantity:t.quantity}))}}}});await e.cart.delete({where:{id:a.id}}),(0,n.cookies)().set("localCartId","")})}},32810:(t,e,a)=>{a.d(e,{_:()=>s});var r=a(53524);let i=globalThis,n=i.prisma??new r.PrismaClient,s=n.$extends({query:{cart:{update:async({args:t,query:e})=>(t.data={...t.data,updatedAt:new Date},e(t))}}})}};